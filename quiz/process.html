<!doctype html><html lang="en" class="h-100">
<head><meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Nowledge November Quiz</title>
<link rel="stylesheet" href="../lib/bootstrap.min.css">
<style>
.answer:hover{background:#eee}
.card{max-width:500px}
</style>
</head><body class="d-flex flex-column h-100 bg-dark">
<header>
<nav class="navbar fixed-top navbar-expand-sm navbar-dark bg-dark py-0 border-bottom border-secondary shadow">
<div class="container-lg">
<a class="navbar-brand font-weight-bold mx-auto py-1" href="index.html">COMMERCE COUNCIL</a>
</div>
</nav>
</header>

<main class="flex-shrink-0 pt-5">
<div class="container">


<div id="quesCard" class="card mt-5 d-none mx-auto">
<span class="card-header d-flex justify-content-between align-items-center h5">
<span>Time: <span id="remainingTime"></span></span>
<span id="remainingQues"></span>
</span>

<div class="card-body text-center">
<p id="question" class="h5 mb-4"></p>

<div class="answer p-2 rounded shadow-sm border mb-2"></div>
<div class="answer p-2 rounded shadow-sm border mb-2"></div>
<div class="answer p-2 rounded shadow-sm border mb-2"></div>
<div class="answer p-2 rounded shadow-sm border mb-2"></div>

</div>
<div class="card-footer d-flex justify-content-between align-items-center">
<button class="btn btn-light border shadow-none font-weight-bold">Score: 
<span id="scoreText">0</span></button>
<button id="nextQuesBtn" class="btn btn-dark font-weight-bold" disabled>Next Question</button>
</div>

</div>

<br><br><br><br><br>

</div>
</main>

<!-- footer start -->
<footer class="footer mt-auto pt-5 bg-dark text-muted text-center">
<div class="container">
<p>RexArvind Web Services &copy; <span id="copyYear">...</span></p>
</div>
</footer>
<!-- footer end -->

<script>
const _=id=>document.getElementById(id)
const qsa=x=>document.querySelectorAll(x)
const quesCard=_("quesCard")
const remainingTime=_("remainingTime")
const remainingQues=_("remainingQues")
const scoreText=_("scoreText")
const nextQuesBtn=_("nextQuesBtn")
const question=_("question")
const answers=qsa(".answer")

const QUIZAPI="https://ccvhpgc.000webhostapp.com/api/quiz/get/"
const ADD_SCORE="https://ccvhpgc.000webhostapp.com/api/quiz/addScore"
const CORRECT_BONUS=2;
const MAX_QUES=2;
const MAX_TIME=5;

let score=quesCounter=0;
let acceptAns=false;
let availableQues=[];
let userID, quizPath

userID=sessionStorage.getItem("key")
sessionStorage.removeItem("key")
sessionStorage.clear()

quizPath=QUIZAPI+userID
fetch(quizPath).then(res=>res.json())
.then(res=>checkData(res))
.catch(err=>{
  quesCard.innerHTML=`
  <p class="text-center p-3">${err}
  ${quizPath}</p>`
  quesCard.classList.remove("d-none")
})

const checkData=res=>{
  if(res.status==false){
  alert(res.message)
  return
  } else if(res.status==true){
  quesCard.classList.remove("d-none")
  startQuiz(res.data)
  }
}

const checkScoreRes=(resStatus, score)=>{
  if(res.status==false){
  quesCard.innerHTML=`
  <p class="text-center p-3">${res.message}</p>`
  return
  } else if(res.status==true){
  sessionStorage.setItem("key", userID)
  sessionStorage.setItem("score", score)
  document.location.href="final.html"
  }
}

const submitQuizData=score=>{
  let fd=new FormData()
  fd.append("uid", userID)
  fd.append("score", score)
  fd.append("maxQues", MAX_QUES)
  fd.append("correctBonus", CORRECT_BONUS)
  var xhr=new XMLHttpRequest()
  xhr.open("POST", ADD_SCORE, true)
  xhr.onreadystatechange = function(){
    if(xhr.readyState==4 && xhr.status==200){
      resStatus=JSON.parse(xhr.responseText)
      checkScoreRes(resStatus, score)
    }
  }
  xhr.onerror = function(){
    alert("Request Error...")
  }
  xhr.send(fd)
}

const startQuiz=data=>{
  score=quesCounter=0;
  availableQues=[...data];
  getNewQues();
}

const shuffle=array=>{
  var currentIndex=array.length;
  var tempValue;
  var randomIndex;
  while (0 !== currentIndex){
    randomIndex=Math.floor(Math.random() * currentIndex);
    currentIndex -= 1; 
    tempValue=array[currentIndex];
    array[currentIndex]=array[randomIndex];
    array[randomIndex]=tempValue;
  }
  return array;
} 

const quesTimer=()=>{
  currentTime=MAX_TIME
  timer=setInterval(countdown,1000)
  function countdown(){
    remainingTime.innerHTML=currentTime
    currentTime--
    if(currentTime < 0){
      acceptAns=false
      remainingTime.innerHTML="0"
      currentTime=0
      showAns()
    }
  }
}

const showAns=()=>{
  clearInterval(timer)
  answers.forEach((answer)=>{
    x=answer.getAttribute("data-ans")
    if(x==currentQues.correct){
      answer.classList.add("bg-success","text-white")
    }
  })
  nextQuesBtn.disabled=""
}

const getNewQues=()=>{
  if(quesCounter >= MAX_QUES){
  nextQuesBtn.innerHTML="Please wait..."
  submitQuizData(score)
  return
  }

  quesCounter++;
  remainingQues.innerHTML=quesCounter+" of "+MAX_QUES
  nextQuesBtn.disabled="true"

  let quesIndex=Math.floor(Math.random() * availableQues.length);
  currentQues=availableQues[quesIndex];
  question.innerHTML=currentQues.ques;
  availableQues.splice(quesIndex, 1);

  var  shuffledAns=Array.from(answers);
  shuffle(shuffledAns)

  shuffledAns.forEach((answer,index)=>{
  answer.classList.remove("bg-success", "bg-danger", "text-white")
  qnum=index+1
  a="ans"+qnum
  answer.innerHTML=currentQues[a]
  answer.setAttribute("data-ans", qnum);
  })
  acceptAns=true
  quesTimer()
}

nextQuesBtn.addEventListener("click",getNewQues)

answers.forEach((answer)=>{
  answer.addEventListener("click",()=>{
  if (!acceptAns) return;

  acceptAns=false
  clickedAns=answer.getAttribute("data-ans")
  if(clickedAns==currentQues.correct){
    answer.classList.add("bg-success","text-white")
    incrementScore(CORRECT_BONUS);
  } else if(clickedAns!=currentQues.correct){
    answer.classList.add("bg-danger","text-white")
    showAns()
  }
  clearInterval(timer)
  nextQuesBtn.disabled=""
  })
})

incrementScore=num=>{
  score+=num;
  scoreText.innerText=score;
}

const date=new Date();
_("copyYear").innerText=date.getFullYear();
</script></body></html>